{% extends 'base.html' %}
{% block content %}
{#<div style="display: flex; justify-content: center; align-items: center; width: 80%; background-color: black;">#}
<div style="display: flex; justify-content: center; align-items: center;">

<div class="sat_pass_table" role="region" tabindex="0">
<table>
    <caption>
        <h3>Satellite Passes</h3>
    </caption>
    <thead>
        <tr>
            <th>Sat_Name</th>
            <th>NORAD</th>
            <th>T_Date</th>
            <th>T_start</th>
            <th>T_end</th>
            <th>Priority</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>

        {% for pas in passes %}
        <tr>
            <td>{{ pas.name }}</td>
            <td>{{ pas.norad }}</td>
            <td>{{ pas.ts.utc_datetime().strftime("%Y-%m-%d") }}</td>
            <td>{{ pas.ts.utc_datetime().strftime("%H:%M:%S") }}</td>
            <td>{{ pas.te.utc_datetime().strftime("%H:%M:%S") }}</td>
            <td>{{ pas.priority }}</td>
            <td>
                <!-- Add a button for selecting this pass -->
                <button class="select-pass-btn"
                        data-azimuths='{{ pas.az }}'
                        data-elevations='{{ pas.alt }}'
                        data-sunlit='{{ pas.sunlighted }}'
                        data-name='{{ pas.name }}'
                        data-norad='{{ pas.norad }}'
                        data-start='{{ pas.ts.utc_datetime().strftime("%Y-%m-%d %H:%M:%S") }}'
                        data-end='{{ pas.te.utc_datetime().strftime("%H:%M:%S") }}'>
                    View Plot
                </button>
            </td>
        </tr>
    {% endfor %}

    </tbody>
</table>
</div>



{#    <div id="skyplot" style="width: 80%; height: 80%;"></div>#}
    <div id="skyplot" style="display: flex; justify-content: center; align-items: center;"></div>
</div>

<script type="text/javascript" src="{{url_for('static', filename='js/plotly-2.35.2.min.js')}}"></script>

<script>
    // Function to update the plot dynamically
    function updatePlot(azimuths, elevations, sunlit, name, norad, start, end) {
        const markerColors = sunlit.map(isSunlit => isSunlit === 1 ? 'white' : '#9c7300');
        const rValues = elevations.map(elevation => 90 - elevation);
        const thetaValues = azimuths;

        const polarData = {
            type: 'scatterpolar',
            mode: 'lines+markers+text',
            r: rValues,
            theta: thetaValues,
            hoverinfo: 'theta+r',
            marker: {
                color: markerColors,
                size: 3
            },
            line: {
                color: 'white',
                width: 2
            }
        };

        const layout = {
            title: {
                text: `Satellite Name: ${name}<br>NORAD: ${norad}<br>${start} - ${end}`,
                font: { color: 'white', size: 14 },
                y: 0.95
            },
            paper_bgcolor: 'black',
            polar: {
                angularaxis: {
                    direction: "clockwise",
                    rotation: 90,
                    gridcolor: 'white',
                    tickcolor: 'white',
                    tickfont: { color: 'white' }
                },
                radialaxis: {
                    range: [0, 90],
                    gridcolor: 'white',
                    tickcolor: 'white',
                    tickfont: { color: 'white' },
                    tickvals: [0, 15, 30, 50, 70, 90],
                    ticktext: ['90', '75', '60', '40', '20', '0'],
                    showticklabels: true
                },
                bgcolor: 'black'
            },
            showlegend: false
        };

        const config = {
            displaylogo: false,
            modeBarButtonsToRemove: ['toImage']
        };

        Plotly.newPlot('skyplot', [polarData], layout, config);
    }

    // Event listener for buttons
    document.querySelectorAll('.select-pass-btn').forEach(button => {
        button.addEventListener('click', () => {
            const azimuths = JSON.parse(button.getAttribute('data-azimuths'));
            const elevations = JSON.parse(button.getAttribute('data-elevations'));
            const sunlit = JSON.parse(button.getAttribute('data-sunlit'));
            const name = button.getAttribute('data-name');
            const norad = button.getAttribute('data-norad');
            const start = button.getAttribute('data-start');
            const end = button.getAttribute('data-end');

            // Update the plot with the selected pass data
            updatePlot(azimuths, elevations, sunlit, name, norad, start, end);
        });
    });
</script>
{% endblock %}
